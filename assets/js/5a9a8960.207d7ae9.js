"use strict";(self.webpackChunkedc_docs=self.webpackChunkedc_docs||[]).push([[904],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),d=a,h=u["".concat(s,".").concat(d)]||u[d]||m[d]||o;return n?r.createElement(h,i(i({ref:t},c),{},{components:n})):r.createElement(h,i({ref:t},c))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},71750:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const o={},i="Telemetry with OpenTelemetry and Micrometer",l={unversionedId:"submodule/Connector/samples/04.3-open-telemetry/README",id:"submodule/Connector/samples/04.3-open-telemetry/README",title:"Telemetry with OpenTelemetry and Micrometer",description:"This sample builds on top of sample 04.0-file-transfer to show how you can:",source:"@site/docs/submodule/Connector/samples/04.3-open-telemetry/README.md",sourceDirName:"submodule/Connector/samples/04.3-open-telemetry",slug:"/submodule/Connector/samples/04.3-open-telemetry/",permalink:"/edc-docs/docs/submodule/Connector/samples/04.3-open-telemetry/",draft:!1,editUrl:"https://github.com/FraunhoferISST/edc-docs/tree/master/docs/submodule/Connector/samples/04.3-open-telemetry/README.md",tags:[],version:"current",frontMatter:{}},s={},p=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Run the sample",id:"run-the-sample",level:2},{value:"Using another monitoring backend",id:"using-another-monitoring-backend",level:2},{value:"Provide your own OpenTelemetry implementation",id:"provide-your-own-opentelemetry-implementation",level:2}],c={toc:p};function m(e){let{components:t,...o}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"telemetry-with-opentelemetry-and-micrometer"},"Telemetry with OpenTelemetry and Micrometer"),(0,a.kt)("p",null,"This sample builds on top of ",(0,a.kt)("a",{parentName:"p",href:"/edc-docs/docs/submodule/Connector/samples/04.0-file-transfer/"},"sample 04.0-file-transfer")," to show how you can:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"generate traces with ",(0,a.kt)("a",{parentName:"li",href:"https://opentelemetry.io"},"OpenTelemetry")," and collect and visualize them with ",(0,a.kt)("a",{parentName:"li",href:"https://www.jaegertracing.io/"},"Jaeger"),"."),(0,a.kt)("li",{parentName:"ul"},"automatically collect metrics from infrastructure, server endpoints and client libraries with ",(0,a.kt)("a",{parentName:"li",href:"https://micrometer.io"},"Micrometer")," and visualize them with ",(0,a.kt)("a",{parentName:"li",href:"https://prometheus.io"},"Prometheus"),".")),(0,a.kt)("p",null,"For this, this sample uses the Open Telemetry Java Agent, which dynamically injects bytecode to capture telemetry from several popular ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/instrumentation"},"libraries and frameworks"),"."),(0,a.kt)("p",null,"In order to visualize and analyze the traces and metrics, we use ",(0,a.kt)("a",{parentName:"p",href:"https://opentelemetry.io/docs/instrumentation/js/exporters/"},"OpenTelemetry exporters")," to export data into the Jaeger tracing backend and a Prometheus endpoint.  "),(0,a.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,a.kt)("p",null,"Download the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.12.0/opentelemetry-javaagent.jar"},"opentelemetry-javaagent.jar")," and place it in the root folder of this sample."),(0,a.kt)("h2",{id:"run-the-sample"},"Run the sample"),(0,a.kt)("p",null,"We will use a single docker-compose to run the consumer, the provider, and a Jaeger backend.\nLet's have a look to the ",(0,a.kt)("a",{target:"_blank",href:n(59706).Z},"docker-compose.yaml"),". We created a consumer and a provider service with entry points specifying the OpenTelemetry Java Agent as a JVM parameter.\nIn addition, the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-java/blob/main/sdk-extensions/autoconfigure/README.md#jaeger-exporter"},"Jaeger exporter")," is configured using environmental variables as required by OpenTelemetry. The ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-java/blob/main/sdk-extensions/autoconfigure/README.md#prometheus-exporter"},"Prometheus exporter")," is configured to expose a Prometheus metrics endpoint."),(0,a.kt)("p",null,"To run the consumer, the provider, and Jaeger execute the following commands in the project root folder:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"./gradlew samples:04.3-open-telemetry:consumer:build samples:04.3-open-telemetry:provider:build\ndocker-compose -f samples/04.3-open-telemetry/docker-compose.yaml up --abort-on-container-exit\n")),(0,a.kt)("p",null,"Once the consumer and provider are up, start a contract negotiation by executing:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST -H "Content-Type: application/json" -H "X-Api-Key: password" -d @samples/04.3-open-telemetry/contractoffer.json "http://localhost:9192/api/v1/management/contractnegotiations"\n')),(0,a.kt)("p",null,"The contract negotiation causes an HTTP request sent from the consumer to the provider connector, followed by another message from the provider to the consumer connector. Query the status of the contract negotiation by executing the following command. Wait until the negotiation is in CONFIRMED state and note down the contract agreement id."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"curl -X GET -H 'X-Api-Key: password' \"http://localhost:9192/api/v1/management/contractnegotiations/{UUID}\"\n")),(0,a.kt)("p",null,"Finally, update the contract agreement id in the ",(0,a.kt)("inlineCode",{parentName:"p"},"filetransfer.json")," file and execute a file transfer with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST -H "Content-Type: application/json" -H "X-Api-Key: password" -d @samples/04.3-open-telemetry/filetransfer.json "http://localhost:9192/api/v1/management/transferprocess"\n')),(0,a.kt)("p",null,"You can access the Jaeger UI on your browser at ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:16686"),".\nIn the search tool, we can select the service ",(0,a.kt)("inlineCode",{parentName:"p"},"consumer")," and click on ",(0,a.kt)("inlineCode",{parentName:"p"},"Find traces"),".\nA trace represents an event and is composed of several spans. You can inspect details on the spans contained in a trace by clicking on it in the Jaeger UI."),(0,a.kt)("p",null,"Example contract negotiation trace:\n",(0,a.kt)("img",{alt:"Contract negotiation",src:n(86842).Z,width:"2826",height:"720"})),(0,a.kt)("p",null,"Example file transfer trace:\n",(0,a.kt)("img",{alt:"File transfer",src:n(57797).Z,width:"2532",height:"1472"})),(0,a.kt)("p",null,"OkHttp and Jetty are part of the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/open-telemetry/opentelemetry-java-instrumentation/tree/main/instrumentation"},"libraries and frameworks")," that OpenTelemetry can capture telemetry from. We can observe spans related to OkHttp and Jetty as EDC uses both frameworks internally. The ",(0,a.kt)("inlineCode",{parentName:"p"},"otel.library.name")," tag of the different spans indicates the framework each span is coming from."),(0,a.kt)("p",null,"You can access the Prometheus UI on your browser at ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:9090"),".\nClick the globe icon near the top right corner (Metrics Explorer) and select a metric to display. Metrics include System (e.g. CPU usage), JVM (e.g. memory usage), Executor service (call timings and thread pools), and the instrumented OkHttp, Jetty and Jersey libraries (HTTP client and server)."),(0,a.kt)("h2",{id:"using-another-monitoring-backend"},"Using another monitoring backend"),(0,a.kt)("p",null,"Other monitoring backends can be plugged in easily with OpenTelemetry. For instance, if you want to use Azure Application Insights instead of Jaeger, you can replace the OpenTelemetry Java Agent with the ",(0,a.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/azure/azure-monitor/app/java-in-process-agent#download-the-jar-file"},"Application Insights Java Agent"),", which has to be stored in the root folder of this sample as well. The only additional configuration required are the ",(0,a.kt)("inlineCode",{parentName:"p"},"APPLICATIONINSIGHTS_CONNECTION_STRING")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"APPLICATIONINSIGHTS_ROLE_NAME")," env variables:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml"},"  consumer:\n    image: openjdk:17-jdk-slim-buster\n    environment:\n      APPLICATIONINSIGHTS_CONNECTION_STRING: <your-connection-string>\n      APPLICATIONINSIGHTS_ROLE_NAME: consumer\n      # optional: increase log verbosity (default level is INFO)\n      APPLICATIONINSIGHTS_INSTRUMENTATION_LOGGING_LEVEL: DEBUG\n      WEB_HTTP_PORT: 8181\n      WEB_HTTP_PATH: /api\n      WEB_HTTP_MANAGEMENT_PORT: 8182\n      WEB_HTTP_MANAGEMENT_PATH: /api/v1/management\n      IDS_WEBHOOK_ADDRESS: http://consumer:8181\n    volumes:\n      - ../:/samples\n    ports:\n      - 9191:8181\n      - 9192:8182\n    entrypoint: java\n      -javaagent:/samples/04.3-open-telemetry/applicationinsights-agent-3.2.8.jar\n      -Djava.util.logging.config.file=/samples/04.3-open-telemetry/logging.properties\n      -jar /samples/04.3-open-telemetry/consumer/build/libs/consumer.jar\n")),(0,a.kt)("p",null,"The Application Insights Java agent will automatically collect metrics from Micrometer, without any configuration needed."),(0,a.kt)("h2",{id:"provide-your-own-opentelemetry-implementation"},"Provide your own OpenTelemetry implementation"),(0,a.kt)("p",null,'In order to provide your own OpenTelemetry implementation, you have to "deploy an OpenTelemetry service provider on the class path":'),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Create a module containing your OpenTelemetry implementation."),(0,a.kt)("li",{parentName:"ul"},"Add a file in the resource directory META-INF/services. The file should be called ",(0,a.kt)("inlineCode",{parentName:"li"},"io.opentelemetry.api.OpenTelemetry"),"."),(0,a.kt)("li",{parentName:"ul"},"Add to the file the fully qualified name of your custom OpenTelemetry implementation class.")),(0,a.kt)("p",null,"EDC uses a ",(0,a.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ServiceLoader.html"},"ServiceLoader")," to load an implementation of OpenTelemetry. If it finds an OpenTelemetry service provider on the class path it will use it, otherwise it will use the registered global OpenTelemetry.\nYou can look at the section ",(0,a.kt)("inlineCode",{parentName:"p"},"Deploying service providers on the class path")," of the ",(0,a.kt)("a",{parentName:"p",href:"https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ServiceLoader.html"},"ServiceLoader documentation")," to have more information about service providers."),(0,a.kt)("hr",null),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"/edc-docs/docs/submodule/Connector/samples/04.2-modify-transferprocess/"},"Previous Chapter")," | ",(0,a.kt)("a",{parentName:"p",href:"/edc-docs/docs/submodule/Connector/samples/file-transfer-cloud/"},"Next Chapter")))}m.isMDXComponent=!0},59706:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/files/docker-compose-61f668a3977d04f2c518b0250578ebb3.yaml"},86842:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/contract-negotiation-trace-fc31ed214fd6d231c693d3b8d7eed75f.png"},57797:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/file-transfer-trace-790f42b778cd61d620ed3735ac13a08c.png"}}]);