<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-submodule/Connector/docs/developer/default_provider_methods">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Advanced dependency resolution: default provider methods | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://FraunhoferISST.github.io/edc-docs/docs/submodule/Connector/docs/developer/default_provider_methods"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Advanced dependency resolution: default provider methods | My Site"><meta data-rh="true" name="description" content="This feature (and this document) is aimed at platform developers who intend to provide additional platform features. It"><meta data-rh="true" property="og:description" content="This feature (and this document) is aimed at platform developers who intend to provide additional platform features. It"><link data-rh="true" rel="icon" href="/edc-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://FraunhoferISST.github.io/edc-docs/docs/submodule/Connector/docs/developer/default_provider_methods"><link data-rh="true" rel="alternate" href="https://FraunhoferISST.github.io/edc-docs/docs/submodule/Connector/docs/developer/default_provider_methods" hreflang="en"><link data-rh="true" rel="alternate" href="https://FraunhoferISST.github.io/edc-docs/docs/submodule/Connector/docs/developer/default_provider_methods" hreflang="x-default"><link rel="stylesheet" href="/edc-docs/assets/css/styles.5bd81ef5.css">
<link rel="preload" href="/edc-docs/assets/js/runtime~main.bbc09bb1.js" as="script">
<link rel="preload" href="/edc-docs/assets/js/main.bdd0bebb.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/edc-docs/"><div class="navbar__logo"><img src="/edc-docs/img/icon.png" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/edc-docs/img/icon.png" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/edc-docs/docs/">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/eclipse-dataspacecomponents/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Advanced dependency resolution: default provider methods</h1><p>This feature (and this document) is aimed at platform developers who intend to provide additional platform features. It
is <strong>not</strong> intended for people who simply want to contribute a technology extension, such as a database implementation
or a storage backend!</p><p>In this document we will use the term &quot;default provider&quot; and &quot;default provider method&quot; synonymously to refer to a method
annotated with <code>@Provider(isDefault=true)</code>. Similarly, &quot;provider&quot;, &quot;provider method&quot; or &quot;factory method&quot;
refer to methods annotated with just <code>@Provider</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="fallbacks-versus-extensibility">Fallbacks versus extensibility<a class="hash-link" href="#fallbacks-versus-extensibility" title="Direct link to heading">​</a></h2><p>Default provider methods are intended to provide fallback implementations for services rather than to achieve
extensibility - that is what extensions are for. There is a subtle but important semantic difference between <em>fallback
implementations</em> and <em>extensibility</em>:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fallback-implementations">Fallback implementations<a class="hash-link" href="#fallback-implementations" title="Direct link to heading">​</a></h3><p>Fallbacks are meant as safety net, in case developers forget or don&#x27;t want to add a specific implementation for a
service. It is there so as not to end up <em>without</em> an implementation for a service interface. A good example for this
are in-memory store implementations. It is expected that an actual persistence implementation is contributed by another
extension. In-mem stores get you up and running quickly, but we wouldn&#x27;t recommend using them in production
environments. Typically, fallbacks should not have any dependencies onto other services.</p><blockquote><p>Default-provided services, even though they are on the classpath, only get instantiated if there is no other
implementation.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="extensibility">Extensibility<a class="hash-link" href="#extensibility" title="Direct link to heading">​</a></h3><p>In contrast, <em>extensibility</em> refers to the possibility of swapping out one implementation of a service for another by
choosing the respective module at compile time. Each implementation must therefore be contained in its own java module,
and the choice between one or the other is made by referencing one or the other in the build file. The service
implementation is typically instantiated and provided by its own extension. In this case, the <code>@Provider</code>-annotation <strong>
must not</strong> have the <code>isDefault</code> attribute. This is also the case if there will likely only ever be one implementation
for a service.</p><p>One example for extensibility is the <code>IdentityService</code>: there could be several implementations for it (OAuth,
DecentralizedIdentity, Keycloak etc.), but providing either one as default would make little sense, because all of them
require external services to work. Each implementation would be in its own module and get instantiated by its own
extension.</p><blockquote><p>Provided services get instantiated only if they are on the classpath, but always get instantiated.</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deep-dive-into-extension-lifecycle-management">Deep-dive into extension lifecycle management<a class="hash-link" href="#deep-dive-into-extension-lifecycle-management" title="Direct link to heading">​</a></h2><p>Generally speaking every extension goes through these lifecycle stages during loading:</p><ul><li><code>inject</code>: all fields annotated with <code>@Inject</code> are resolved</li><li><code>initialize</code>: the <code>initialize()</code> method is invoked. All required collaborators are expected to be resolved after this.</li><li><code>provide</code>: all <code>@Provider</code> methods are invoked, the object they return is registered in the context.</li></ul><p>Due to the fact that default provider methods act a safety net, they only get invoked if no other provider method offers
the same service type. However, what may be a bit misleading is the fact that they typically get invoked <em>during the
<code>inject</code> phase</em>. The following section will demonstrate this.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-1---provider-method">Example 1 - provider method<a class="hash-link" href="#example-1---provider-method" title="Direct link to heading">​</a></h3><p>Recall that <code>@Provider</code> methods get invoked regardless, and after the <code>initialze</code> phase. That means, assuming both
extensions are on the classpath, the extension that declares the provider method (= <code>ExtensionA</code>) will get fully
instantiated before another extension (= <code>ExtensionB</code>) can use the provided object:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ExtensionA { // gets loaded first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SomeStore store; // provided by some other extension</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SomeService getSomeService() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SomeServiceImpl(store);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ExtensionB { // gets loaded second</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SomeService service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After building the dependency graph, the loader mechanism would first fully construct <code>ExtensionA</code>, i.e.
<code>getSomeService()</code> is invoked, and the instance of <code>SomeServiceImpl</code> is registered in the context. Note that this is
done regardless whether another extension <em>actually injects a <code>SomeService</code></em>. After that, <code>ExtensionB</code> gets constructed,
and by the time it goes through its <code>inject</code> phase, the injected <code>SomeService</code> is already in the context, so the
<code>SomeService</code> field gets resolved properly.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-2---default-provider-method">Example 2 - default provider method<a class="hash-link" href="#example-2---default-provider-method" title="Direct link to heading">​</a></h3><p>Methods annotated with <code>@Provider(isDefault=true)</code> only get invoked if there is no other provider method for that
service, and at the time when the corresponding <code>@Inject</code> is resolved. Modifying example 1 slightly we get:</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ExtensionA {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SomeStore store;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Provider(isDefault = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SomeService getSomeService() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new SomeServiceImpl(store);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ExtensionB {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Inject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private SomeService service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The biggest difference here is the point in time at which <code>getSomeService</code> is invoked. Default provider methods get
invoked <em>when the <code>@Inject</code> dependency is resolved</em>, because that is the &quot;latest&quot; point in time that that decision can
be made. That means, they get invoked during <code>ExtensionB</code>&#x27;s inject phase, and <em>not</em> during <code>ExtensionA</code>&#x27;s provide phase.
There is no guarantee that <code>ExtensionA</code> is already initialized by that time, because the extension loader does not know
whether it needs to invoke <code>getSomeService</code> at all, until the very last moment, i.e. when resolving <code>ExtensionB</code>&#x27;s
<code>service</code> field. By that time, the dependency graph is already built.</p><p>Consequently, default provider methods could (and likely would) get invoked before the defining extension&#x27;s <code>provide</code>
phase has completed. They even could get invoked before the <code>initialize</code> phase has completed: consider the following
situation the previous example:</p><ol><li>all implementors of <code>ServiceExtension</code> get constructed by the Java <code>ServiceLoader</code></li><li><code>ExtensionB</code> gets loaded, runs through its inject phase</li><li>no provider for <code>SomeService</code>, thus the default provider kicks in</li><li><code>ExtensionA.getSomeService()</code> is invoked, but <code>ExtensionA</code> is not yet loaded -&gt; <code>store</code> is null</li><li>-&gt; potential NPE</li></ol><p>Because there is no explicit ordering in how the <code>@Inject</code> fields are resolved, the order may depend on several factors,
like the Java version or specific JVM used, the classloader and/or implementation of reflection used, etc.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="usage-guidelines-when-using-default-providers">Usage guidelines when using default providers<a class="hash-link" href="#usage-guidelines-when-using-default-providers" title="Direct link to heading">​</a></h2><p>From the previous sections and the examples demonstrated above we can derive a few important guidelines:</p><ul><li>do not use them to achieve extensibility. That is what extensions are for.</li><li>use them only to provide a <em>fallback implementation</em></li><li>they should not depend on other injected fields (as those may still be null)</li><li>they should be in their own dedicated extension (cf. <code>DefaultServicesExtension</code>) and Java module</li><li>do not provide and inject the same service in one extension</li><li>rule of thumb: unless you know exactly what you&#x27;re doing and why you need them - don&#x27;t use them!</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/FraunhoferISST/edc-docs/tree/master/docs/submodule/Connector/docs/developer/default_provider_methods.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fallbacks-versus-extensibility" class="table-of-contents__link toc-highlight">Fallbacks versus extensibility</a><ul><li><a href="#fallback-implementations" class="table-of-contents__link toc-highlight">Fallback implementations</a></li><li><a href="#extensibility" class="table-of-contents__link toc-highlight">Extensibility</a></li></ul></li><li><a href="#deep-dive-into-extension-lifecycle-management" class="table-of-contents__link toc-highlight">Deep-dive into extension lifecycle management</a><ul><li><a href="#example-1---provider-method" class="table-of-contents__link toc-highlight">Example 1 - provider method</a></li><li><a href="#example-2---default-provider-method" class="table-of-contents__link toc-highlight">Example 2 - default provider method</a></li></ul></li><li><a href="#usage-guidelines-when-using-default-providers" class="table-of-contents__link toc-highlight">Usage guidelines when using default providers</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 My Project,  built with Fraunhofer ISST.</div></div></div></footer></div>
<script src="/edc-docs/assets/js/runtime~main.bbc09bb1.js"></script>
<script src="/edc-docs/assets/js/main.bdd0bebb.js"></script>
</body>
</html>